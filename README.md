# Тестовый проект: «кассовый аппарат» для вымышленного магазина.

## Оглавление

1. [Описание ТЗ](#описание-тз)
2. [О выполненном проекте](#о-выполненном-проекте)
   - [Важные особенности проекта](#важные-особенности-проекта)
   - [Используемый стек](#используемый-стек)
   - [Внешнее ПО](#внешнее-ПО)
3. [Запуск и демонстрация проекта](#запуск-и-демонстрация-проекта)
   - [Демонстрация приложения на удалённом сервере](#демонстрация-приложения-на-удалённом-сервере)
   - [Локальный запуск приложения с использованием Docker](#локальный-запуск-приложения-с-использованием-docker)
   - [Локальный запуск приложения без использования Docker](#локальный-запуск-приложения-без-использования-docker)
4. [Тестирование приложения](#тестирование-приложения)
5. [Вопросы и ответы](#вопросы-и-ответы)

## Описание ТЗ

Перед получением информации о выполненном проекте предлагаю ознакомиться с подробной информацией о требованиях к проекту:

<details>
  <summary>Открыть информацию</summary>

### Требования:

1. Необходимо написать «кассовый аппарат» для вымышленного магазина.
2. При выполнении задания необходимо использовать <b>Python 3 и Django, Django Rest Framework</b>

### Условия:

#### Описание принципа работы «кассового аппарата»:

#### Этап 1

Предварительно нужно будет написать модель данных для товара Item.

Модель должна содержать следующие поля:
```
  | id    | айди товара  |
  | title | наименование |
  | price | стоимость    |
```

На веб-узел ```{{root}}/cash_machine``` с помощью метода <b>POST</b> отправляется следующее тело запроса:

```JSON
  {
      "items": [1, 2, 3]
  }
```
где items это массив id товаров модели Item.

При этом запросе сервер должен формировать чек в формате PDF.

Пример чека:

![test_receipt.png](readme_media%2Ftest_receipt.png)

В чек должны записываться следующие поля:

1. Для каждой позиции товара:
   - Наименование
   - Общее количество
   - Общая стоимость
2. Итоговая сумма
3. Время создания чека в формате (ДД.ММ.ГГГГ Ч:М)

HTML-шаблон чека приложен к заданию. Подставить вышеуказанные поля туда можно с помощью Jinja2. Для работы с PDF рекомендуется использовать библиотеку ```pdfkit```: https://pypi.org/project/pdfkit/

Сформированный PDF файл нужно просто сохранять в папку ```media```

Затем сервер формирует ссылку на этот PDF-файл и кодирует его в QR-код, а затем высылает этот QR-код в качестве ответа на запрос. Для работы с QR-кодами рекомендуется использовать библиотеку ```qrcode```:
https://pypi.org/project/qrcode/

#### Этап 2

При сканировании QR-код будет совершаться запрос <b>GET</b> ```{{root}}/media/<наименование файла>``` который в ответ будет возвращать этот файл.

Решение нужно будет загрузить на GitHub, либо Gitlab, либо Bitbucket как публичный репозиторий

### Рекомендации

Во время тестирования решения рекомендуется на Этапе 2 запускать сервер в локальной сети, чтобы была возможность тестирования сканирования QR-кода через телефон.

Для этого в ```settings.py``` в <b>ALLOWED_HOSTS</b> напишите следующее:
```
ALLOWED_HOSTS = ['*']
```

Затем при запуске приложения указывайте IP-адрес вашей машины в локальной сети.

Например: ```python manage.py runserver 192.168.0.1:8000```

</details>

## О выполненном проекте

Проект cash_machine представляет собой API для управления кассовыми чеками, с возможностью сохранения данных в формате PDF и генерации QR-кодов.

### Важные особенности проекта

- **Соблюдение ТЗ**: Проект строго следует техническому заданию, реализуя генерацию HTML-шаблонов с использованием Jinja2, создание pdf-файлов с помощью pdfkit и генерацию QR-кодов с использованием qrcode. Все реализованные функции соответствуют поставленным задачам и обеспечивают требуемый функционал.

- **Гибкость разворачивания**: Проект обеспечивает легкость развертывания в любом окружении. Вы можете запустить его локально без контейнеров, локально с использованием Docker, а также проверить функционал приложения на удаленном сервере.

- **Контейнеризация с Docker**: Проект упакован в контейнеры с использованием Docker и Docker Compose, обеспечивая легкость развертывания в различных окружениях.

- **Автоматизированное тестирование**: Реализованы тесты для различных компонентов приложения, гарантируя надежность и корректность его работы. Тесты запускаются при развертывании контейнеров или могут быть запущены вручную для проверки функциональности.

- **Автоматизация с pre-commit**: В проекте реализован pre-commit, автоматизирующий проверку кода на соответствие стандартам перед каждым коммитом. Это обеспечивает единообразие кода и улучшает его качество.

- **Логгирование для отслеживания действий**: Внедрено логгирование, которое фиксирует ключевые действия приложения, обеспечивая прозрачность и отслеживание работы системы.

### Используемый стек

<details>
  <summary>Открыть информацию (нажать на эту строчку, чтобы открыть):</summary>

- **Python**: Версия 3.11
- **Django**: Версия 4.2.7
- **Django REST framework**: Библиотека для разработки RESTful API.
- **Jinja2**: Шаблонизатор для генерации HTML-кода, обеспечивает динамичное форматирование данных в шаблонах.
- **pdfkit с wkhtmltopdf**: Инструментарий для создания PDF-файлов из HTML-шаблонов, обеспечивает форматирование и структурирование документов.
- **qrcode**: Библиотека для генерации QR-кодов, используется для создания уникальных идентификаторов и быстрой передачи информации.
- **pytest**: Фреймворк для тестирования приложения, автоматизирует процесс проверки корректности кода и функциональности приложения.
- **drf-spectacular**: Инструмент для автоматической генерации OpenAPI-спецификации API на основе кода Django REST Framework, обеспечивает документирование и взаимодействие с API.
- **pre-commit**: Автоматическая проверка и форматирование кода перед коммитом
- **gunicorn**: WSGI HTTP-сервер для обслуживания Django-приложения.

</details>

### Внешнее ПО

<details>
  <summary>Открыть информацию (нажать на эту строчку, чтобы открыть):</summary>

- **PyCharm**: Интегрированная среда разработки Python.
- **Docker**: Контейнеризация приложения и зависимостей для легкого развертывания.
- **Postman**: Инструмент для тестирования и проверки функциональности API.
- **Google Chrome**: Браузер для проверки работоспособности приложения (через Swagger).
- **Смартфон**: Камера смартфона, поддерживающая сканирование QR-кодов для перехода на страницу с кассовым чеком.

</details>

## Запуск и демонстрация проекта

Пользователь может проверить доступные пути API проекта, уже развёрнутом на удалённом сервере, либо развернуть проект на своей локальной машине (с использованием Docker или без).

### Демонстрация приложения на удалённом сервере

#### Доступные пути API:

- **http://158.160.48.231/cash_machine**: веб-узел для принятия POST-запроса на генерацию QR-кода.


- **http://158.160.48.231/api/v1/create_items/**: веб-узел для загрузки тестового наполнения БД.
- **http://158.160.48.231/api/v1/swagger-ui/#/**: Swagger - Интерактивная документация API для ознакомления с функциональностью и возможными ошибками.
- **http://158.160.48.231/api/v1/redoc/**: Redoc - Интерактивная документация API для ознакомления с функциональностью и возможными ошибками.


- **http://158.160.48.231/admin/** - Консоль администратора
```
  Параметры входа:
    Username = admin
    Passowrd = test_admin
 ```

### Локальный запуск приложения с использованием Docker

<details>
  <summary>Подробная инструкция (<b>нажмите на эту строчку, чтобы открыть</b>):</summary>

#### Для локальной установки проекта необходимо выполнить следующие шаги:

### Установка и настройка внешнего ПО:
- Docker: Если у вас ещё не установлен Docker, следуйте инструкциям на официальном сайте Docker для вашей операционной системы: https://docs.docker.com/get-docker/. После установки убедитесь, что Docker Daemon запущен.
- Docker Compose: Установите Docker Compose, если он ещё не установлен. Docker Compose используется для управления многоконтейнерными приложениями. Инструкции по установке можно найти здесь: https://docs.docker.com/compose/install/

### Запуск приложения:
- Клонирование репозитория
```
git@github.com:Leenominai/test_cash_machine.git
```
- Переход в рабочую папку приложения
```
cd backend
```
- Настройка файлов окружения: Создайте файл окружения .env в корне вашего проекта.
- Скопируйте все данные из файла .env.example в файл .env:
  - Сейчас в файле .env.example присутствуют значения всех необходимых переменных только для локальной проверки приложения, а для сервера все переменные скрыты в GitHub Secrets.
- Запуск контейнеров: Запустите приложение с помощью Docker Compose:
```
cd ..
cd docker_local
docker-compose up -d
```
- Создание профиля администратора:
```
docker exec -it test_backend bash
python manage.py createsuperuser
exit
```

### Доступные пути API

- **http://192.168.31.12:8000/cash_machine**: веб-узел для принятия POST-запроса на генерацию QR-кода.



- **http://192.168.31.12:8000/api/v1/create_items/**: веб-узел для загрузки тестового наполнения БД.
- **http://192.168.31.12:8000/api/v1/swagger-ui/#/**: Swagger - Интерактивная документация API для ознакомления с функциональностью и возможными ошибками.
- **http://192.168.31.12:8000/api/v1/redoc/**: Redoc - Интерактивная документация API для ознакомления с функциональностью и возможными ошибками.


- **http://192.168.31.12:8000/admin/** - Консоль администратора

```
  Параметры входа в консоль - какие были указаны при создании профиля администратора.
 ```

</details>

### Локальный запуск приложения без использования Docker

<details>
  <summary>Подробная инструкция (<b>нажмите на эту строчку, чтобы открыть</b>):</summary>

#### Для локальной установки проекта необходимо выполнить следующие шаги:

### Запуск приложения:
- Клонирование репозитория
```
git@github.com:Leenominai/test_cash_machine.git
```
- Переход в рабочую папку приложения
```
cd backend
```
- Настройка файлов окружения: Создайте файл окружения .env в корне вашего проекта.
- Скопируйте все данные из файла .env.example в файл .env:
  - Сейчас в файле .env.example присутствуют значения всех необходимых переменных только для локальной проверки приложения, а для сервера все переменные скрыты в GitHub Secrets.
- Создание миграций и профиля администратора:
```
cd cash_machine
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser
```
- Запуск приложения:
```
python manage.py runserver 192.168.31.12:8000
```

### Доступные пути API

- **http://192.168.31.12:8000/cash_machine**: веб-узел для принятия POST-запроса на генерацию QR-кода.



- **http://192.168.31.12:8000/api/v1/create_items/**: веб-узел для загрузки тестового наполнения БД.
- **http://192.168.31.12:8000/api/v1/swagger-ui/#/**: Swagger - Интерактивная документация API для ознакомления с функциональностью и возможными ошибками.
- **http://192.168.31.12:8000/api/v1/redoc/**: Redoc - Интерактивная документация API для ознакомления с функциональностью и возможными ошибками.


- **http://192.168.31.12:8000/admin/** - Консоль администратора

```
  Параметры входа в консоль - какие были указаны при создании профиля администратора.
 ```

</details>

## Тестирование приложения

### Для удалённого сервера (Postman):

Для тестирования через программу Postman необходимо:
- Установить её на свою рабочую машину с официального сайта: https://www.postman.com/
- После установки необходимо перейти в раздел Workspaces
- Создать новый Request через +, либо изменить стандартный
- В шкалу URL необходимо ввести следующий адрес: ```http://158.160.48.231/cash_machine```
- Слева от введённого адреса выбрать тип запроса: POST
- Далее, необходимо выбрать блок Body, раздел raw, тип JSON (синяя стрелочка с выбором справа).
- Для загрузки используем следующий формат:

```JSON
{
    "items": [1, 2, 3]
}
```

- Нажать кнопку Send (отправить запрос)
- После успешного выполнения запроса будет получен ответ системы с картинкой QR-кода:

  <details>
    <summary>Пример ответа программы Postman с QR-кодом (<b>нажмите на эту строчку, чтобы открыть</b>):</summary>

  ![test_qr_code.png](readme_media%2Ftest_qr_code.png)

  </details>

- На данный QR-код необходимо навести камеру смартфона с включенным приложением, поддерживающим сканирование QR-кодов.
- После успешного сканирования QR-кода на вашем смартфоне произойдёт автоматическая переадресация на данный кассовый чек в вашем мобильном браузере по-умолчанию.

#### Примечания:

- На сервере уже создано тестовое наполнение в виде нескольких id, в том числе под номера 1, 2, 3.
- Если файлов с запрашиваемыми id не существует, либо если потребуется ввести иные id для генерации кассового чека с другими данными, то потребуются следующие действия:

- Создать новый Request через +, либо изменить стандартный
- В шкалу URL необходимо ввести следующий адрес: ```http://158.160.48.231/api/v1/create_items/```
- Слева от введённого адреса выбрать тип запроса: POST
- Далее, необходимо выбрать блок Body, раздел raw, тип JSON (синяя стрелочка с выбором справа).
- Для загрузки используем следующий формат (пример запроса, измените id на необходимые):

```JSON
[
    {"id": 1, "title": "Макароны", "price": 80},
    {"id": 2, "title": "Огурцы", "price": 60},
    {"id": 3, "title": "Картошка", "price": 50}
]
```

- Далее снова повторить POST-запрос на следующий адрес: ```http://158.160.48.231/cash_machine```, как было расписано выше.


## Тестирование в Postman при локальной установке

Для тестирования через программу Postman необходимо:
- Установить её на свою рабочую машину с официального сайта: https://www.postman.com/
- После установки необходимо перейти в раздел Workspaces
- Создать новый Request через +, либо изменить стандартный
- В шкалу URL необходимо ввести следующий адрес: http://127.0.0.1:8000/api/v1/upload/
- Слева от введённого адреса выбрать тип запроса: POST
- Далее, необходимо выбрать блок Body и раздел form-data под ним.
- Для загрузки используем следующий формат:
```
    | Key      | Value                 | Допустимые значения для поля Value |
    | ---------| --------------------- | ---------------------------------- |
    | data     | <Ваш текст>           | Длина до 3145728 символов (3 МБ)   |
    | name     | <Ваше название файла> | Длина до 128 символов              |

```
- Нажать кнопку Send (отправить запрос)
<details>
  <summary>При возможных ошибках загрузок в блоке Headers ставим следующую настройку (<b>нажмите на эту строчку, чтобы открыть</b>):</summary>

    | Key         | Value            |
    | ----------- | ---------------- |
    | ContentType | application/json |

</details>

- После успешного выполнения запроса будет получен ответ системы:

  ```
  [
      {
          "Выполнено": "Документ успешно создан.",
          "file_name": "test_document1"
      }
  ]
  ```
- Если такой файл уже существует в хранилище Google Drive, то система выдаст соответствующую ошибку:
   ```
   [
       {
           "Ошибка": "Документ с таким именем уже существует."
       }
   ]
   ```

#### Можно визуально проверить создание токена и авторизацию через браузер, для этого необходимо:

- Перейти в рабочую папку Django-проекта в приложение api:
  ```
    cd ..
    cd backend/docmanager/api
  ```
- Удалить файл с существующим токеном авторизации тестового аккаунта через визуальный интерфейс или командой в консоли:
  ```
    rm token.json.enc
  ```
- Нажать кнопку Send (отправить запрос)
- После этого при выполнении запроса будет выполнено автоматическое перенаправление на страницу авторизации аккаунта Google в вашем браузере по-умолчанию, где будет необходимо войти в аккаунт Google со следующими данными:

    <details>
      <summary>Данные для авторизации в Google-аккаунт (<b>нажмите на эту строчку, чтобы открыть</b>):</summary>

        | Email    | test.nova.user001@gmail.com |
        | Password | test_nova                   |

    </details>

        Это новый тестовый аккаунт для тестирования данного приложения.
        Он авторизован в системе Google Drive API как доступный для тестирования.
        Прочие аккаунты будут заблокированы для доступа к API.

- Если пользователь уже вошёл под этим аккаунтом, то ему отобразится список авторизованных аккаунтов, в списке которого нужно будет выбрать Test User:

    ![google_account.png](media%2Fgoogle_account.png)

- После чего будет необходимо предоставить доступ приложению на работу с Google Drive API.

    <details>
      <summary>Визуальная инструкция - как это будет выглядеть в браузере (<b>нажмите на эту строчку, чтобы открыть</b>):</summary>

  ![google_api1.png](media%2Fgoogle_api1.png)
  ![google_api1.png](media%2Fgoogle_api2.png)

    </details>

- После чего пользователь на странице авторизации в браузере получит ответ:
    ```
    The authentication flow has completed. You may close this window.
    ```

- Необходимо снова вернуться в интерфейс программы Postman, где можно будет увидеть ответ системы:
    ```
    [
        {
            "Выполнено": "Документ успешно создан.",
            "file_name": "test_document1"
        }
    ]
    ```

 - Если такой файл уже существует в хранилище Google Drive, то система выдаст соответствующую ошибку:
    ```
    [
        {
            "Ошибка": "Документ с таким именем уже существует."
        }
    ]
    ```

#### Загруженный файл можно проверить визуально. Для этого необходимо:

- Необходимо перейти на официальную страницу Google Drive: https://drive.google.com/drive/u/2/my-drive
- После этого необходимо авторизоваться в системе под данными тестового аккаунта Google, созданного для проверки приложения:

  <details>
    <summary>Данные для авторизации в Google-аккаунт (<b>нажмите на эту строчку, чтобы открыть</b>):</summary>

      | Email    | test.nova.user001@gmail.com |
      | Password | test_nova                   |

  </details>

- В списке файлов можно будет увидеть только что созданный файл.

## Разработчики

Проект разработан и поддерживается Александром Рассыхаевым.

GitHub: [Ссылка на GitHub профиль](https://github.com/Leenominai)

Telegram: [@Leenominai](https://t.me/Leenominai)
